# Claw CLI Demo – 系统化开发说明文档

---

# 1. 项目概述

## 1.1 项目目标

构建一个基于 **Python CLI** 的智能助手 Demo，具备以下能力：

1. 简单的 Chat CLI 交互窗口
2. 基于 grep 的长期记忆系统（Markdown 文件）
3. Skill 技能机制（工具调用）
4. 使用 OpenAI v1 compatible SDK 调用大模型
5. 所有参数通过默认配置文件管理

---

# 2. 功能范围

## 2.1 Chat 能力

- 支持持续对话
- 支持短期上下文记忆（最近 N 轮）
- 支持长期记忆检索（grep 方式）
- 支持技能调用

---

## 2.2 支持的 Skills

通过 skill 调度机制支持以下功能：

1. 查天气（weather）
2. 查文件（file_search）
3. 读文件（file_read）
4. 写摘要（summarize）
5. 发邮件（email）

技能调用方式：  
模型输出 JSON → 程序解析 → 调度执行 → 返回结果 → 再次调用模型生成最终回答。

---

# 3. 技术栈

- 语言：Python 3.10+
- CLI 框架：Typer
- LLM SDK：OpenAI v1 compatible
- 配置文件：YAML
- 记忆系统：Markdown + grep
- 技能调度：函数白名单机制
- 日志：标准 logging

---

# 4. 项目结构

```text
claw/
│
├── main.py
├── chat.py
├── config.py
├── llm.py
│
├── memory/
│ ├── memory_manager.py
│ └── knowledge/
│ ├── data_structure.md
│ ├── profile.md
│ ├── facts.md
│ ├── episodes/
│ └── index/memory_keys.tsv
│
├── skills/
│ ├── dispatcher.py
│ ├── weather.py
│ ├── file_search.py
│ ├── file_read.py
│ ├── summarize.py
│ └── email.py
│
└── config.yaml
```

---

# 5. CLI 设计

## 5.1 命令行入口

claw chat
claw mem search "<query>"
claw mem add --key <key> --type profile|fact --content "..."
claw mem purge


---

## 5.2 Chat 内部斜杠命令

- `/exit` → 退出
- `/mem` → 显示当前检索到的记忆
- `/reset` → 清空短期对话历史

---

# 6. 配置文件设计（config.yaml）

```yaml
model: gpt-4o-mini
base_url: https://api.openai.com/v1
api_key: YOUR_API_KEY
temperature: 0.3

memory:
  path: ./memory/knowledge
  max_inject: 3

smtp:
  host: smtp.example.com
  port: 587
  username: user@example.com
  password: password
```

---

# 7. LLM 调用设计
## 7.1 SDK 使用方式

```python
from openai import OpenAI

client = OpenAI(
    base_url=config.base_url,
    api_key=config.api_key
)

response = client.chat.completions.create(
    model=config.model,
    messages=messages,
    temperature=config.temperature,
)
```

---

## 7.2 Prompt 结构

```yaml
System:
你是一个 CLI AI 助手。
你拥有以下技能：
- weather
- file_search
- file_read
- summarize
- email

如果需要使用技能，请输出 JSON 格式：
{"skill": "...", "args": {...}}

否则直接输出自然语言。

Long-term Memory:
<检索到的记忆片段>

Recent Conversation:
<最近5轮对话>

User:
<当前输入>

```

---

# 8. 记忆系统设计（grep 版本）
## 8.1 存储结构

profile.md
存长期偏好信息。
```markdown
## pref:answer_style
- type: profile
- tags: preference
- updated_at: 2026-02-11
- content: 用户喜欢简洁回答。
```

---

facts.md
存可复用事实。
```markdown
## project:current_demo
- type: fact
- tags: project,cli
- updated_at: 2026-02-11
- content: 用户正在开发 Python CLI demo。
```

---

memory_keys.tsv
```tsv
pref:answer_style	profile.md
project:current_demo	facts.md
```

---

## 8.2 记忆检索流程

 1. 对 profile.md 和 facts.md 执行 grep
 2. 获取命中段落（上下文 ±6 行）
 3. 打分规则：
	 - key 命中 +2
	 - content 命中 +1
	 - 更新时间新 +1
 4. 取 Top 3 注入 Prompt

---

## 8.3 写入策略（Upsert）

 - 如果 key 已存在：
	 - 替换对应段落
	 - 更新 updated_at
 - 如果不存在：
	 - 追加到文件末尾
	 - 同步更新 memory_keys.tsv

---

# 9. Skill 系统设计
## 9.1 Skill 调度机制

模型输出 JSON：
```json
{
  "skill": "weather",
  "args": {
    "city": "Beijing"
  }
}
```
程序解析 skill 字段并调用对应模块。

---

## 9.2 各 Skill 说明
weather
输入：
```json
{
  "city": "Beijing"
}
```
输出：
```
Beijing 当前天气：晴 20°C
```

---

file_search
参数：
```json
{
  "query": "report",
  "path": "./"
}
```
功能：在指定路径中搜索文件名。

---

file_read
参数：
```json
{
  "path": "example.txt"
}
```
功能：读取文件内容。

---

summarize
参数：
```json
{
  "text": "长文本"
}
```
功能：调用 LLM 对文本进行摘要。

---

email
参数：
```json
{
  "to": "xxx@example.com",
  "subject": "标题",
  "body": "正文"
}
```
功能：通过 SMTP 发送邮件。

---

# 10. Chat 执行流程

```text
while True:
    user_input
        ↓
    memory_search()
        ↓
    build_prompt()
        ↓
    call_llm()
        ↓
    if JSON(skill):
        dispatch_skill()
        append_result_to_context()
        call_llm_again()
    else:
        return answer
        ↓
    memory_extract_and_upsert()
```

---

# 11. 记忆抽取规则（第一版）
若用户输入包含：
 - “我喜欢”
 - “我不喜欢”
 - “我正在做”
 - “我的目标是”
则自动生成 key：
 - pref:<xxx>
 - project:<xxx>
 - goal:<xxx>
并执行 upsert 写入。

---

# 12. 安全与约束
 - 所有 Skill 必须白名单注册
 - 文件操作限制在允许目录内
 - 邮件发送必须配置验证
 - 不自动写入敏感信息
 - 所有 IO 必须异常处理
 - 支持 --verbose 调试模式

---

# 13. MVP 验收标准
运行：
```bash
claw chat
```
系统必须支持：
 - 记住用户偏好
 - 查天气
 - 查文件
 - 读文件
 - 写摘要
 - 发邮件
 - 使用 grep 记忆系统

# 14. 未来扩展方向（非当前版本）
 - 向量数据库替换 grep
 - 多用户 profile
 - ReAct Agent 模式
 - Web UI
 - Plugin 机制

# 版本定义
当前版本：v0.1 CLI Demo
定位：本地可运行、结构清晰、可扩展的 AI CLI Demo 框架