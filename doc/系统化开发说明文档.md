# Claw CLI Demo - 系统化开发说明文档（v0.2 修订稿）

## 1. 文档目标
本稿基于 `doc/系统化开发说明文档.md` 的补充与修订，目标是把设计从“可讨论”提升到“可直接开发+可验收”。

## 2. 约束与范围

### 2.1 必须满足（MVP）
1. CLI Chat 交互窗口（可持续对话）
2. 5 个能力：查天气、查文件、读文件、写摘要、发邮件（通过 skill 机制）
3. 长期记忆采用渐进式 grep 检索（非向量库）
4. Python 实现
5. 模型调用使用 OpenAI v1 compatible SDK
6. 参数从默认配置文件读取

### 2.2 本期不做
1. 多用户隔离
2. Web UI
3. 分布式部署
4. 向量数据库

## 3. 与原稿相比的关键修订
1. 增加明确的模块边界（chat/llm/memory/skills/config）
2. 把 skill 调用从“纯文本 JSON 约定”升级为“结构化协议 + 参数校验”
3. 把记忆检索细化为“渐进式四阶段检索 + 去重打分”
4. 增加文件与邮件能力的安全边界（路径白名单、大小限制、dry-run）
5. 增加配置校验与默认值策略（Pydantic）
6. 增加失败策略（重试、超时、降级响应）
7. 增加最小测试矩阵与验收脚本

## 4. 推荐项目结构（Python）

```text
claw_demo/
  __init__.py
  main.py
  cli.py
  chat/
    engine.py
    prompt_builder.py
    slash_commands.py
  llm/
    client.py
    schemas.py
    planner.py
  memory/
    manager.py
    grep_retriever.py
    writer.py
    extractor.py
    store/
      profile.md
      facts.md
      episodes/
      index/memory_keys.tsv
  skills/
    dispatcher.py
    registry.py
    models.py
    builtin/
      weather.py
      file_search.py
      file_read.py
      summarize.py
    external/
      email_skill/
        SKILL.md
        run.py
  config/
    default.yaml
    schema.py
    loader.py
  tests/
    test_memory_retrieval.py
    test_skill_dispatch.py
    test_chat_flow.py
    test_config_validation.py
```

## 5. CLI 设计（修订）

### 5.1 命令
```bash
claw chat
claw mem search "<query>"
claw mem add --key <key> --type profile|fact|episode --content "..."
claw mem purge --scope profile|fact|episode|all
claw skill list
claw skill check
```

### 5.2 Chat 内部命令
1. `/exit` 退出
2. `/reset` 清空短期会话
3. `/mem` 展示本轮注入记忆
4. `/skills` 展示当前可用 skill
5. `/dryrun on|off` 打开发邮件 dry-run

## 6. 配置设计（default.yaml）

```yaml
app:
  name: claw-cli-demo
  timezone: Asia/Shanghai
  verbose: false

llm:
  provider: openai_compatible
  model: gpt-4o-mini
  base_url: https://api.openai.com/v1
  api_key: ${OPENAI_API_KEY}
  temperature: 0.3
  timeout_sec: 60
  max_retries: 2

chat:
  recent_turns: 8
  max_context_chars: 12000
  stream: true

memory:
  root: ./memory/store
  inject_top_k: 3
  grep_context_lines: 6
  max_item_chars: 1200
  enable_auto_extract: true

skills:
  enabled:
    - weather
    - file_search
    - file_read
    - summarize
    - email
  timeout_sec: 20

file_access:
  allowed_roots:
    - ./
  max_read_bytes: 262144

weather:
  provider: open-meteo
  default_city: Shanghai
  units: metric

email:
  enabled: false
  dry_run: true
  smtp:
    host: smtp.example.com
    port: 587
    username: ${SMTP_USERNAME}
    password: ${SMTP_PASSWORD}
    from: bot@example.com
```

修订点：
1. 敏感信息全部走环境变量引用，不在文档中放明文密钥
2. 增加超时、重试、大小限制等运行参数
3. email 默认 `enabled: false` + `dry_run: true`

## 7. LLM 调用与技能协议

### 7.1 调用方式
使用 OpenAI SDK（v1 compatible）：`client.chat.completions.create(...)`。

### 7.2 协议建议
不要依赖“模型随意输出 JSON”，改为固定响应外壳：

```json
{
  "type": "final" | "skill_call",
  "text": "...",
  "skill": {
    "name": "weather",
    "args": {}
  }
}
```

策略：
1. 先让模型返回结构化响应
2. 若解析失败，自动追加一次“仅返回合法 JSON”重试
3. 仍失败则降级为纯文本回答

## 8. Skill 体系（修订）

### 8.1 统一接口
每个 skill 均实现：
```python
def run(args: dict, ctx: SkillContext) -> SkillResult:
    ...
```

### 8.2 参数模型（必须）
每个 skill 使用 Pydantic 定义参数模型；调度前先校验，失败直接返回可读错误。

### 8.3 各 skill 的最低约束
1. `weather(city)`：城市为空时使用默认城市；失败返回“天气服务暂不可用”
2. `file_search(query, path="./")`：path 必须在 `allowed_roots` 内
3. `file_read(path)`：文件大小不得超过 `max_read_bytes`
4. `summarize(text)`：文本过长时分段摘要后聚合
5. `email(to, subject, body)`：仅在 `email.enabled=true` 执行真实发送，否则 dry-run

## 9. 渐进式记忆（grep 版本）

### 9.1 数据结构
沿用：`profile.md`、`facts.md`、`episodes/*.md`、`memory_keys.tsv`。

### 9.2 渐进式检索算法
1. Query 规范化：小写、去标点、分词
2. Stage A（精确 key）：在 `memory_keys.tsv` 先查 key 命中
3. Stage B（标题/标签）：对 markdown 标题与 `tags` grep
4. Stage C（内容扩展）：对正文 grep，返回上下文 `±N` 行
5. Stage D（重排）：按 `key_hit/content_hit/recency/diversity` 打分
6. 去重后取 top-k 注入 prompt

评分建议：
- key 命中 +3
- 标题/标签命中 +2
- content 命中 +1
- 7 天内更新 +1
- 与已选条目重复主题 -1

### 9.3 写入策略（Upsert）
1. key 已存在：原子替换段落并更新时间
2. key 不存在：追加段落并更新 `memory_keys.tsv`
3. 写入采用临时文件 + rename，避免中断导致文件损坏

## 10. Chat 执行流程（修订）

```text
user_input
  -> parse slash command?
  -> progressive_memory_search()
  -> build_messages()
  -> llm_plan_or_answer()
  -> if skill_call: dispatch_with_validation_and_timeout()
       -> append skill result
       -> llm_final_answer()
  -> render output
  -> memory_extract_and_upsert(optional)
```

## 11. 安全与边界
1. skill 白名单注册，未知 skill 一律拒绝
2. 文件读写限制在 `allowed_roots`
3. 严格限制单次读取大小与超时时间
4. SMTP 凭据仅环境变量注入
5. 日志脱敏（api_key、password、token）
6. 默认不开启真实邮件发送

## 12. 测试与验收

### 12.1 单测最低覆盖
1. memory：四阶段检索、打分、去重
2. skill：参数校验、越权路径拒绝、timeout
3. chat：skill 往返流程与降级流程
4. config：默认值与非法配置报错

### 12.2 MVP 验收脚本
```bash
claw chat
# 在 chat 中验证：
# 1) 询问天气
# 2) file_search
# 3) file_read
# 4) summarize
# 5) email (dry-run)
# 6) 第二轮提及偏好并验证记忆命中
```

通过标准：
1. 五个能力均可触发
2. 至少一条用户偏好可被后续轮次命中
3. 非法路径读取被拒绝
4. email 在默认配置下仅 dry-run

## 13. 参考 openclaw 的可借鉴点（系统性分析结论）
1. 配置层要“读取 + 校验 + 默认值 + 警告”一体化，不只做 YAML 解析
2. skill 元数据建议可扩展（可执行条件、依赖、是否允许模型自动调用）
3. memory 写入要过滤非用户/助手消息，避免 tool/system 噪音污染长期记忆
4. 关键流程应有可测试的边界函数，而不是全塞在 chat 主循环

## 14. 版本结论
- 原稿可作为 v0.1 草案
- 本修订稿建议作为 v0.2 开发基线
