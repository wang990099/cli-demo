# Claw CLI Demo - 系统化开发说明文档（v0.2 修订稿）

## 1. 文档目标
本稿基于 `doc/系统化开发说明文档.md` 的补充与修订，目标是把设计从“可讨论”提升到“可直接开发+可验收”。

## 2. 约束与范围

### 2.1 必须满足（MVP）
1. CLI Chat 交互窗口（可持续对话）
2. 5 个能力：查天气、查文件、读文件、写摘要、发邮件（通过 skill 机制）
3. 长期记忆采用渐进式 grep 检索（非向量库）
4. Python 实现
5. 模型调用使用 OpenAI v1 compatible SDK
6. 参数从默认配置文件读取

### 2.2 本期不做
1. 多用户隔离
2. Web UI
3. 分布式部署
4. 向量数据库

## 3. 与原稿相比的关键修订
1. 增加明确的模块边界（chat/llm/memory/skills/config）
2. 把 skill 调用从“纯文本 JSON 约定”升级为“结构化协议 + 参数校验”
3. 把记忆检索细化为“渐进式四阶段检索 + 去重打分”
4. 增加文件与邮件能力的安全边界（路径白名单、大小限制、dry-run）
5. 增加配置校验与默认值策略（Pydantic）
6. 增加失败策略（重试、超时、降级响应）
7. 增加最小测试矩阵与验收脚本

## 4. 推荐项目结构（Python）

```text
claw_demo/
  __init__.py
  main.py
  cli.py
  chat/
    engine.py
    prompt_builder.py
    slash_commands.py
  agent/
    workflow_runner.py
  memory/
    manager.py
    grep_retriever.py
    writer.py
    extractor.py
    store/
      profile.md
      facts.md
      episodes/
      index/memory_keys.tsv
  skills/
    dispatcher.py
    loader.py
    models.py
    toolbox.py
    agents/
      weather/SKILL.md
      file_search/SKILL.md
      file_read/SKILL.md
      summarize/SKILL.md
      email/SKILL.md
  config/
    default.yaml
    schema.py
    loader.py
  tests/
    test_memory_retrieval.py
    test_skill_dispatch.py
    test_chat_flow.py
    test_config_validation.py
```

## 5. CLI 设计（修订）

### 5.1 命令
```bash
claw chat
claw mem search "<query>"
claw mem add --key <key> --type profile|fact|episode --content "..."
claw mem purge --scope profile|fact|episode|all
claw skill list
claw skill check
```

### 5.2 Chat 内部命令
1. `/exit` 退出
2. `/reset` 清空短期会话
3. `/mem` 展示本轮注入记忆
4. `/memtype` 查看/切换会话记忆类型（auto/profile/fact/episode）
5. `/skills` 展示当前可用 skill
6. `/dryrun on|off` 打开发邮件 dry-run

## 6. 配置设计（default.yaml）

```yaml
app:
  name: claw-cli-demo
  timezone: Asia/Shanghai
  verbose: false

llm:
  provider: openai_compatible
  model: gpt-4o-mini
  base_url: https://api.openai.com/v1
  api_key: ${OPENAI_API_KEY}
  temperature: 0.3
  timeout_sec: 60
  max_retries: 2

chat:
  recent_turns: 8
  max_context_chars: 12000
  stream: true

memory:
  root: ./memory/store
  inject_top_k: 3
  grep_context_lines: 6
  max_item_chars: 1200
  enable_auto_extract: true
  default_mem_type: auto
  episode_retention_days: 14
  episode_recent_days: 7
  episode_recent_boost: 2
  episode_stale_penalty: 2
  episode_decay_half_life_days: 3
  episode_trigger_keywords:
    - 进展
    - 今天做了
    - 刚完成
    - 刚遇到问题
    - 决定
    - 总结
    - 会议
    - 计划

skills:
  enabled:
    - weather
    - time
    - file_search
    - file_read
    - summarize
    - email
  timeout_sec: 20
  max_steps: 6
  import_dirs: []

file_access:
  allowed_roots:
    - ./
  max_read_bytes: 262144

weather:
  provider: open-meteo
  default_city: Shanghai
  units: metric

email:
  enabled: false
  dry_run: true
  smtp:
    host: smtp.example.com
    port: 587
    username: ${SMTP_USERNAME}
    password: ${SMTP_PASSWORD}
    from: bot@example.com
```

修订点：
1. 敏感信息全部走环境变量引用，不在文档中放明文密钥
2. 增加超时、重试、大小限制等运行参数
3. email 默认 `enabled: false` + `dry_run: true`

## 7. LLM 调用与工作流协议

### 7.1 调用方式
使用 OpenAI SDK（v1 compatible）：`client.chat.completions.create(...)`。

### 7.2 协议建议
Chat 入口采用统一 Workflow Agent，不再做单 skill 路由的固定 JSON 外壳。
模型在工作流中自主决策工具调用与步骤推进，系统在运行时检查目标完成度。
策略：
1. 通过工具循环完成多步骤任务
2. 对复合目标执行“必需工具完成检查”
3. 超过步数上限后返回失败信息并提示拆分任务

## 8. Skill 体系（修订）

### 8.1 Agent Skill 统一接口
每个 skill 由 `SKILL.md` 定义，不再采用固定 `run(args)` 接口。

### 8.2 执行模型
1. 模型先读取 skill 的 `instructions`
2. 在统一 runner 环境中自主规划步骤
3. 按需调用统一工具集（weather/file_search/file_read/summarize/email）
4. 循环最多 `skills.max_steps` 轮后输出最终答案

### 8.3 外部导入
通过 `skills.import_dirs` 支持导入外部 agent skills，目录支持：
1. `<dir>/agents/<skill>/SKILL.md`
2. `<dir>/<skill>/SKILL.md`

## 9. 渐进式记忆（grep 版本）

### 9.1 数据结构
沿用：`profile.md`、`facts.md`、`episodes/*.md`、`memory_keys.tsv`。

Episode 策略：
1. 命中事件触发词（如“进展/今天做了/刚完成/决定/总结/会议/计划”）优先写入 `episode`
2. `episode` 统一写入当日文件：`episodes/YYYY-MM-DD-episode.md`
3. 启动、检索、写入前执行过期清理，仅保留最近 `episode_retention_days`

### 9.2 渐进式检索算法
1. Query 规范化：小写、去标点、分词
2. Stage A（精确 key）：在 `memory_keys.tsv` 先查 key 命中
3. Stage B（标题/标签）：对 markdown 标题与 `tags` grep
4. Stage C（内容扩展）：对正文 grep，返回上下文 `±N` 行
5. Stage D（重排）：按 `key_hit/content_hit/recency/diversity` 打分
6. 去重后取 top-k 注入 prompt

评分建议：
- key 命中 +3
- 标题/标签命中 +2
- content 命中 +1
- `recent_days` 内更新 +1
- `episode` 使用时间衰减函数：`boost*exp(-age/half_life)-penalty*(1-exp(-age/half_life))`
- 与已选条目重复主题 -1

### 9.3 写入策略（Upsert）
1. key 已存在：原子替换段落并更新时间
2. key 不存在：追加段落并更新 `memory_keys.tsv`
3. 写入采用临时文件 + rename，避免中断导致文件损坏
4. `updated_at` 统一写入秒级时间戳（`YYYY-MM-DDTHH:MM:SS`）
5. `profile` 在写入后执行规范化：
   - 偏好类收敛到 `pref:like:*` / `pref:dislike:*`
   - 同一对象的喜欢/不喜欢冲突仅保留最新状态
   - 重建 `memory_keys.tsv`，清理陈旧 key

## 10. Chat 执行流程（修订）

```text
user_input
  -> parse slash command?
  -> progressive_memory_search()
  -> workflow_agent_run()
       -> model plans multi-step objective
       -> iterative tool calls in unified runner
       -> required-tools completion check
       -> final answer
  -> render output
  -> memory_propose_verify_commit(optional)
```

## 11. 安全与边界
1. skill 白名单注册，未知 skill 一律拒绝
2. 文件读写限制在 `allowed_roots`
3. 严格限制单次读取大小与超时时间
4. SMTP 凭据仅环境变量注入
5. 日志脱敏（api_key、password、token）
6. 默认不开启真实邮件发送

## 12. 测试与验收

### 12.1 单测最低覆盖
1. memory：四阶段检索、打分、去重
2. skill：agent loop、工具边界控制、外部导入加载
3. chat：skill 往返流程与流式输出
4. config：默认值与非法配置报错

### 12.2 MVP 验收脚本
```bash
claw chat
# 在 chat 中验证：
# 1) 询问天气
# 2) file_search
# 3) file_read
# 4) summarize
# 5) email (dry-run)
# 6) 第二轮提及偏好并验证记忆命中
```

通过标准：
1. 五个能力均可触发
2. 至少一条用户偏好可被后续轮次命中
3. 非法路径读取被拒绝
4. email 在默认配置下仅 dry-run

## 13. 参考 openclaw 的可借鉴点（系统性分析结论）
1. 配置层要“读取 + 校验 + 默认值 + 警告”一体化，不只做 YAML 解析
2. skill 元数据建议可扩展（可执行条件、依赖、是否允许模型自动调用）
3. memory 写入要过滤非用户/助手消息，避免 tool/system 噪音污染长期记忆
4. 关键流程应有可测试的边界函数，而不是全塞在 chat 主循环

## 14. 版本结论
- 原稿可作为 v0.1 草案
- 本修订稿建议作为 v0.2 开发基线
